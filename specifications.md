# 休暇申請システム仕様書

## 1. 概要

本システムは、Firebase を利用した休暇申請および承認プロセスを電子化するためのウェブアプリケーションである。
従業員は自身の休暇申請をオンラインで行い、承認者はそれを承認または差し戻すことができる。また、総務担当者およびシステム管理者は、それぞれの権限に応じた管理機能を持つ。

## 2. システム利用者（ロール）と権限

本システムには以下の4つのロールが存在する。

| ロール | 説明 | 主な機能 |
| :--- | :--- | :--- |
| **一般ユーザー** | 休暇申請を行う従業員。 | ・休暇申請の作成、送信<br>・自身の申請状況の確認<br>・差し戻された申請の再申請または削除 |
| **承認ユーザー** | 申請を承認または差し戻す権限を持つ従業員。 | ・担当する申請の確認<br>・申請の承認または差し戻し<br>・（自身も一般ユーザーとして申請可能） |
| **総務担当者** | 全従業員の申請状況を管理する従業員。 | ・全従業員の申請状況の閲覧<br>・申請の削除<br>・（自身も一般ユーザーとして申請可能） |
| **システム管理者** | ユーザー登録や権限設定を行う。 | ・全ロールのユーザー登録、情報編集、削除<br>・一般ユーザーと承認者の関連付け<br>・（自身のロール設定も可能） |

**補足:**
- 承認ユーザーおよび総務担当者は、一般ユーザーとしての機能（自身の休暇申請）も利用できる。
- システム管理者は、必要に応じて自身に一般ユーザー、承認ユーザー、総務担当者のロールを割り当て、各機能を利用することができる。
- 一般ユーザーと承認ユーザーの関係は多対多（N:N）である。つまり、一人の申請が複数の承認者を必要とする場合や、一人の承認者が複数の申請者を担当する場合がある。

## 3. 機能要件

### 3.1. 認証機能

- **パスワードレス認証:**
    - 認証はメールアドレスのみで行い、パスワードは使用しない。
    - ユーザーがシステムに登録されたメールアドレスを入力すると、認証用のURLが記載されたメールが送信される。
    - ユーザーはそのURLをクリックすることでシステムにログインできる。
    - 認証URLには有効期限が設定される。
- **アクセスコントロール:**
    - システムに登録されていないメールアドレスではログインできない。
    - ログイン後、各ユーザーは自身のロールに応じた画面と機能にのみアクセスできる。

### 3.2. 申請画面（一般ユーザー）

- **申請フォーム:**
    - 以下の情報を入力し、申請を送信する。
        - **休暇の種別:**
            - 有給休暇（終日）
            - 有給休暇（半休AM）
            - 有給休暇（半休PM）
            - 振替休暇
            - 特別休暇
            - 慶弔休暇
        - **期間と日数:**
            - 半休以外は開始日と終了日を選択し、期間を指定できる。
            - 期間に応じて日数が自動計算される。
        - **休暇理由:** 休暇取得の理由を記載する。
        - **事前相談:**
            - 相談相手の名前
            - 相談手段（SMS等、口頭、電話）
- **申請一覧:**
    - 自身の申請履歴（送信済み、承認待ち、承認済み、差し戻し）を一覧で確認できる。
    - 各申請のステータスが表示される。
- **申請の編集と削除:**
    - **送信後**の申請は、承認者によって差し戻されない限り、**編集・削除はできない**。
    - **差し戻された**申請に限り、内容を修正して**再申請**するか、**申請自体を削除**することができる。

### 3.3. 承認画面（承認ユーザー）

- **承認待ち一覧:**
    - 自身が承認すべき申請を一覧で確認できる。
- **申請の処理:**
    - 各申請の詳細を確認し、「承認」または「差し戻し」を選択する。
    - 差し戻す場合は、理由をコメントとして**入力する必要がある**。
- **承認済み一覧:**
    - 自身が過去に処理（承認・差し戻し）した申請の履歴を確認できる。
- **編集・削除の制約:**
    - 一度処理した申請（承認・差し戻し済み）を、承認者が後から編集・削除することはできない。

### 3.4. 申請状況画面（総務担当者）

- **全申請の閲覧:**
    - 全従業員の休暇申請状況を横断的に閲覧できる。
- **申請の削除:**
    - 必要に応じて、特定の申請を削除する権限を持つ。
    - 申請内容の**編集はできない**。

### 3.5. システム管理者画面

- **ユーザー管理:**
    - 全てのロール（一般ユーザー、承認ユーザー、総務担当者、システム管理者）のユーザーを管理する。
    - 登録情報：メールアドレス、名前、役職。
- **ロール設定:**
    - 新規ユーザー登録時、または既存ユーザーに対してロールを割り当てる。
- **承認フロー設定:**
    - 一般ユーザーと、その申請を承認する承認ユーザーを関連付ける設定画面を持つ。
- **初期管理者アカウント:**
    - システムの初回デプロイ時に、あらかじめシステム管理者のアカウントが1つ登録されている状態にする。

### 3.6. 通知機能

- **メール通知:**
    - 申請時、承認時、差し戻し時に、関係者（申請者、承認者）にメールで通知が届く。
    - メールには、申請内容や結果を確認できる画面へのURLが記載される。
- **URLトークン:**
    - 通知メールに記載されるURLには、有効期限が1日のトークンが含まれる。

## 4. 非機能要件

- **プラットフォーム:** Firebaseの各種サービス（Authentication, Firestore, Hosting, Functions）を利用して構築する。

## 5. Firestoreデータベース設計

データベースは以下のコレクションで構成される。

### `users`コレクション

全ユーザーの情報を格納する。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `userId` | `string` | ドキュメントID（Firebase AuthenticationのUID） |
| `name` | `string` | ユーザー名 |
| `email` | `string` | メールアドレス |
| `roles` | `array` | ユーザーのロールを格納 (`user`, `approver`, `payroll`, `admin`) |
| `createdAt` | `timestamp` | 作成日時 |
| `updatedAt` | `timestamp` | 更新日時 |

### `leave_applications`コレクション

全ての休暇申請情報を格納する。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `applicationId`| `string` | ドキュメントID |
| `applicantId` | `string` | 申請者の`userId`（`users`への参照） |
| `approverIds` | `array` | 承認者の`userId`のリスト（`users`への参照） |
| `status` | `string` | 申請ステータス (`pending`, `approved`, `rejected`) |
| `leaveType` | `string` | 休暇種別（有給休暇（終日）など） |
| `startDate` | `date` | 休暇開始日 |
| `endDate` | `date` | 休暇終了日 |
| `totalDays` | `number` | 休暇日数 |
| `reason` | `string` | 休暇理由 |
| `consultationPartner` | `string` | 事前相談の相手 |
| `consultationMethod` | `string` | 事前相談の方法 |
| `rejectionComment` | `string` | 差し戻し理由 |
| `history` | `array` | ステータス変更履歴（オブジェクトの配列: { status, timestamp, actorId }） |
| `createdAt` | `timestamp` | 作成日時 |
| `updatedAt` | `timestamp` | 更新日時 |

### `approval_flows`コレクション

誰が誰の申請を承認するかを定義する。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `applicantId`| `string` | 申請者の`userId`（ドキュメントID） |
| `approverIds` | `array` | この申請者を承認するユーザーの`userId`リスト |
